# pbi-params — R Package Development Instructions

## Project Goal

Build an R package (`pbiparams`) that safely extracts values from a Power BI parameter table (1 row, multiple columns) without string concatenation or injection of raw values into scripts.

## R Version

Target R **4.3.3**. Do not use features introduced after 4.3.3.

## Package Structure

```
pbi-params/
├── CLAUDE.md
├── DESCRIPTION
├── NAMESPACE
├── LICENSE
├── LICENSE.md
├── R/
│   └── safe_param.R        # core function + internal helpers
├── man/                    # generated by roxygen2, do not edit manually
└── tests/
    ├── testthat.R
    └── testthat/
        └── test-safe_param.R
```

## Key Design Decisions

- **No base pipe (`|>`) issues**: `|>` is available in R 4.1+ so it is safe to use.
- **Zero hard dependencies**: The package must have no `Imports` beyond base R. Power BI R script environments are locked-down; extra packages may not be available.
- **No `%||%`**: That operator lives in `rlang`. Inline the null-coalescing logic directly.
- **Single exported function**: `safe_param()` is the public API. Internal helpers (if any) use `.` prefix and are not exported.
- **Vectorised-safe but single-value focused**: Power BI params are always 1 row. Extracting one column → one scalar value is the primary use case.

## Core Function Contract (`safe_param`)

```r
safe_param(
  params_or_value,           # data.frame (PBI param table) OR a bare scalar
  col        = NULL,         # column name to extract (required when data.frame)
  row        = 1,            # row index (default 1)
  target     = c("numeric","integer","character","logical","date","datetime"),
  default    = NULL,         # returned when value is missing/NA
  integer_strategy = c("round","floor","ceiling","truncate"),
  make_positive = FALSE,
  min_val    = -Inf,
  max_val    = Inf,
  trim_ws    = TRUE,
  na_values  = c("", "NA", "NaN", "null", "Null", "NULL"),
  date_formats = c("%Y-%m-%d", "%m/%d/%Y", "%d-%b-%Y", "%Y/%m/%d"),
  tz         = "UTC"
)
```

**Safety guarantee**: all values are extracted and coerced programmatically — never spliced as raw strings into SQL, DAX, or file paths.

## Tooling

- Use **roxygen2** for documentation (`@export`, `@param`, `@examples`).
- Use **testthat** (>= 3.0) for tests.
- Use **devtools** for the development workflow: `devtools::load_all()`, `devtools::test()`, `devtools::check()`, `devtools::build()`.

## DESCRIPTION Fields

```
Package: pbiparams
Title: Safe Parameter Extraction for Power BI R Scripts
Version: 0.1.0
Authors@R: person("Chris Aragao", role = c("aut", "cre"), email = "Christopher.Aragao@gmail.com")
Description: Safely extracts and coerces values from a Power BI parameter
    table (one row, multiple columns) without string concatenation or
    injection of raw values.
License: MIT + file LICENSE
Encoding: UTF-8
RoxygenNote: 7.x.x
Suggests: testthat (>= 3.0.0)
Config/testthat/edition: 3
```

## Typical Power BI Usage Pattern

```r
# Power BI passes a data.frame called `params` with one row
source("safe_param.R")   # or library(pbiparams) if installed

start_date <- safe_param(params, "StartDate", target = "date")
top_n      <- safe_param(params, "TopN",      target = "integer", default = 10L, min_val = 1L)
region     <- safe_param(params, "Region",    target = "character", default = "All")
is_debug   <- safe_param(params, "Debug",     target = "logical",   default = FALSE)

# Use values directly — never paste() them into SQL strings
```

## Development Workflow

```r
devtools::load_all()   # load package into session for interactive testing
devtools::test()       # run testthat suite (78 tests)
devtools::document()   # regenerate man/ from roxygen2 comments
devtools::check()      # full CRAN-style check (0 errors, 0 warnings, 0 notes)
devtools::install()    # install into local R library (required for Power BI)
```
